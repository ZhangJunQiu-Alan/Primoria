# Database Design (PostgreSQL)
System principles: any "state field updates caused by user actions" use a 5-minute debounce by default; any "audit/analytics events" use append-only + partitioning.
last_active: debounce 5 minutes
last_accessed: debounce 5 minutes
streak/day log: upsert by day
interactions: insert-only, partition by month

## Table Design

### 1. User Management

#### profiles (user profile)
| Column | Type | Notes |
| --- | --- | --- |
| id | uuid | PK, FK -> auth.users.id, user id generated by the system |
| username | text | UNIQUE, CHECK (length(username) between 3 and 32), display name, unique |
| avatar_url | text | Avatar URL |
| bio | text | Bio (limit 100 Chinese chars / 200 English chars; truncate with "..." after about 2 lines or about 40 chars) |
| role | Enum ('user','subscriber','author','admin') | User role: user-regular user, subscriber-subscriber, author-course creator, admin-administrator |
| created_at | timestamp | Account creation time |
| updated_at | timestamp | Maintained by trigger, update time (used for avatar refresh, cache updates, security audit, permission change tracking) |
| last_active_at | timestamp | Last active time (for activity metrics). On request, do not write directly to Postgres. Record "recent active time" in Redis/memory, batch write every 5 minutes |

#### user_settings (user settings)
| Column | Type | Notes |
| --- | --- | --- |
| user_id | UUID (PK, FK) | PK & FK -> profiles.id, user ID |
| theme_mode | Enum ('system','light','dark') | Default: system, theme mode |
| notification_daily_reminder | Boolean | Default: false, daily reminder toggle |
| notification_reminder_time | Time | Default: '09:00', reminder time |
| marketing_emails | Boolean | Default: false, marketing emails toggle |
| language | Text | Language (default 'zh-CN') |
| accessibility_mode | Boolean | Default: false, accessibility mode |

### 2. Course Content

#### subjects (subjects/categories)
| Column | Type | Notes |
| --- | --- | --- |
| id | UUID (PK) | Default: gen_random_uuid() primary key |
| name | Text | UNIQUE subject name (e.g., "Computer Science", "Physics") |
| icon_url | Text | Link to SVG or PNG icon, used on homepage category cards |
| color_hex | Text | CHECK (color_hex ~ '^#[0-9A-Fa-f]{6}$'), stores hex color (e.g., #FF5733). In Flutter this is parsed as Color(0xFFFF5733) and used as the subject theme background or gradient |
| parent_subject_id | UUID (FK) | FK -> subjects.id (nullable) parent category ID (for subcategories, e.g., Math -> Algebra) |

#### courses (courses)
| Column | Type | Notes |
| --- | --- | --- |
| id | UUID (PK) | Default: gen_random_uuid() primary key |
| author_id | UUID (FK) | FK -> profiles.id, author ID |
| subject_id | UUID (FK) | FK -> subjects.id, subject ID |
| title | Text | Course title |
| slug | Text | UNIQUE (lowercase + hyphens; generated at app layer). Good for SEO and sharing. Must be globally unique |
| description | Text | Course description |
| thumbnail_url | Text | Course cover image URL |
| difficulty_level | Enum ('beginner', 'intermediate', 'advanced') | Default: 'beginner', used for filtering or recommending based on level |
| status | Enum ('draft', 'published', 'archived') | Default 'draft'. Publish status: draft - only author can see (editing in Builder); published - visible to learners (learn in Viewer); archived - hidden but data retained |
| estimated_minutes | Integer | Default: 0, estimated duration, used to display "about 2 hours" |
| tags | Array<Text> | Default: {} PostgreSQL array type. Used for search optimization, e.g., ['recursion','algorithms','Python'] |
| price_tier | Enum ('free', 'premium') | Default: free. Distinguish free vs paid. Frontend uses this to show a "lock" icon |
| created_at | Timestamp | Default: now() creation time |
| updated_at | timestamptz | Default: now() trigger |
| published_at | timestamptz | Set only when published |
| search_tsv | tsvector | Generated column (title/description/tags) for full-text search |

#### chapters (chapters/modules)
| Column | Type | Notes |
| --- | --- | --- |
| id | UUID (PK) | Default: gen_random_uuid() primary key |
| course_id | UUID (FK) | FK -> courses.id, course ID |
| title | Text | Chapter title |
| description | Text | Chapter description |
| sort_key | bigint | Default: 1000, leave gaps for insert/drag (e.g., 1000,2000,3000) to determine order (Chapter 1, Chapter 2). Builder updates this field on save |
| is_locked | Boolean | Default: True. Gamification design. The first lesson is false. If true, the previous chapter must be completed to unlock (or payment required) |
UNIQUE(course_id, sort_key) prevents order conflicts

#### lessons (sub-lessons) includes snapshot data for fast Viewer rendering
| Column | Type | Notes |
| --- | --- | --- |
| id | UUID (PK) | Primary key |
| chapter_id | UUID (FK) | FK -> chapters.id, chapter ID |
| title | Text | Lesson title |
| type | Enum ('interactive', 'quiz', 'video', 'article') | Default: interactive, lesson type |
| sort_key | bigint | Default: 1000, constraint: UNIQUE(chapter_id, sort_key) lesson order; Builder updates on save |
| xp_reward | Integer | Default: 0 CHECK (xp_reward >= 0) XP reward for completing the lesson |
| duration_seconds | Integer | Default: 0, estimated duration (seconds) |
| content_json | JSONB | Default: '{}'. Aggregated snapshot of all content_blocks under this lesson, including the sorted page structure |
| content_hash | text | Hash of course content for change detection and cache validation |
| created_at | timestamptz | now() creation time |
| updated_at | timestamptz | now() trigger updated time |

#### content_blocks (content blocks) are the Source of Truth. All Builder CRUD operations target this table directly
| Column | Type | Notes |
| --- | --- | --- |
| id | UUID (PK) | Primary key |
| lesson_id | UUID (FK) | FK -> lessons.id, owning lesson |
| type | Enum ('text', 'image', 'code_playground', 'multiple_choice', 'slider', 'info_card') | Component type, determines render logic |
| content | JSONB | Static display data (e.g., prompt text, default code) |
| config | JSONB | Logic/config data (e.g., validation rules, answers, ranges) |
| sort_key | bigint | Default: 1000, constraint: UNIQUE(lesson_id, sort_key). Determines block order on page, supports drag sorting. Builder updates on save |
| is_interactive | Boolean | Whether user interaction is required |
| created_at | timestamptz | Default: now() creation time |
| updated_at | timestamptz | Default: now() trigger updated time |
| updated_by | uuid | FK -> profiles.id (audit/collaboration) |

Strategy details and workflow

The core logic is to separate the concerns of "editing" and "reading":

1. **Write flow (Builder & Authoring)**:
* After the author edits a course in Builder and clicks Save or Publish, the system performs atomic operations on the `content_blocks` table (Insert/Update/Delete). This enables fine-grained content search at the database level (e.g., "find all blocks that contain Python 2 code").
* **Sync mechanism (Snapshot)**: When the author runs Save or Publish, the backend triggers aggregation: query all Blocks under the Lesson, sort by `sequence_order`, package into a full JSON object, and update the `content_json` field in the `lessons` table.

2. **Read flow (Viewer & Rendering)**:
* The Viewer only needs to request the `lessons` table. By reading `content_json`, the client can get all data for rendering in a single network request (1 RTT), avoiding complex joins and greatly improving first paint and UX.

3. **Analytics flow**:
* Even though the Viewer renders JSON, each component still retains the original `block_id`.
* When a user interacts (e.g., submit code, drag a slider), the report includes `block_id`. This lets us trace back to `content_blocks` and precisely analyze pass rates and interaction details for each knowledge point, enabling fine-grained teaching quality optimization.

The `sort_key` fields in the three tables are only updated on Save or Publish to avoid frequent DB writes.
**Downsides of `sort_key`** and **corresponding solutions**
### 1. Gap exhaustion (theoretical)
**Problem**
* Multiple inserts within the same range shrink key gaps
**Solution**
* Use `BIGINT`
* When adjacent diff <= 2, re-rank the chapter/lesson
* Re-ranking only occurs on "Save / Publish"
> Very low probability, acceptable
---
### 2. Sort key not intuitive
**Problem**
* `sort_key` values are not human-friendly
**Solution**
* UI uses `row_number()` to generate display order
* Docs note that `sort_key` is an internal implementation detail
---
### 3. Queries must have indexes
**Problem**
* `order by sort_key` without an index is slow
**Solution**
* Create composite indexes:
  * `(course_id, sort_key)`
  * `(chapter_id, sort_key)`
  * `(lesson_id, sequence_order)`

### 3. Learning & Progress

#### enrollments (course enrollments)
| Column | Type | Default | Notes |
| --- | --- | --- | --- |
| id | uuid | gen_random_uuid() | PK |
| user_id | uuid | | FK -> profiles.id, user ID |
| course_id | uuid | | FK -> courses.id, course ID |
| status | Enum ('in_progress', 'completed', 'dropped') | Default: 'in_progress' current status (in progress, completed, dropped) |
| progress_bp | integer | 0 | Basis points 0~10000 (replace float for better control). CHECK (progress_bp between 0 and 10000). Frontend progress bar reads this field directly. Each lesson completion triggers a backend function to update this field |
| last_accessed_at | timestamptz | now() | Last access time |
| started_at | timestamptz | now() | Start time |
| completed_at | timestamptz | | Completion time |
| | | | UNIQUE(user_id, course_id) prevents duplicate enrollments |

#### lesson_completions (lesson completion records)
| Column | Type | Notes |
| --- | --- | --- |
| id | UUID (PK) | Primary key |
| user_id | UUID (FK) | User ID |
| lesson_id | UUID (FK) | Lesson ID |
| score | Integer | Lesson score (if quiz) |
| time_spent_seconds | Integer | Final time spent (seconds) |
| completed_at | Timestamp | Completion time |

#### block_interactions (interaction details)
| Column | Type | Notes |
| --- | --- | --- |
| id | UUID (PK) | Primary key |
| user_id | UUID (FK) | User ID |
| block_id | UUID (FK) | Block ID |
| user_input | JSONB | Records what the user did; user input (code, options, slider value) |
| is_correct | Boolean | Whether the interaction succeeded. Used to analyze the pass rate of a specific knowledge block and help authors optimize content |
| created_at | Timestamp | Creation time |

### 4. Gamification

#### user_stats (user stats - real-time cache; do not traverse all history every profile load, which would cause slow DB queries)
| Column | Type | Notes |
| --- | --- | --- |
| user_id | UUID (PK, FK) | User ID |
| total_xp | Integer | Total XP earned |
| current_streak | Integer | Current consecutive check-in days, a key retention metric |
| longest_streak | Integer | Highest historical streak |
| courses_completed | Integer | Completed courses |
| lessons_completed | Integer | Completed lessons |
| last_activity_date | Date | Last active date (used to compute streak) |

#### daily_activity_log (daily activity log; design intent: generate a GitHub-style "green wall" contribution heatmap)
| Column | Type | Notes |
| --- | --- | --- |
| user_id | UUID (FK) | User ID |
| date | Date | Date |
| xp_earned | Integer | Total XP earned that day |
| lessons_count | Integer | Lessons completed that day |
| **Primary Key** | **(user_id, date)** | Composite PK ensures one row per user per day. Each new XP event runs INSERT ... ON CONFLICT (user_id, date) DO UPDATE SET xp_earned = xp_earned + EXCLUDED.xp_earned ..., generating a GitHub-style heatmap and avoiding duplicate rows |

#### achievements (achievement definitions)
| Column | Type | Notes |
| --- | --- | --- |
| id | UUID (PK) | Primary key |
| slug | Text | Unique identifier referenced in code (e.g., 'first_lesson', '7_day_streak') |
| name | Text | Achievement name |
| description | Text | Achievement description |
| icon_url | Text | Achievement icon |
| category | Enum ('streak', 'learning', 'social') | Category for UI tabs (e.g., "Learning Achievements", "Social Achievements") |

#### user_achievements (user earned achievements)
| Column | Type | Notes |
| --- | --- | --- |
| id | UUID (PK) | Primary key |
| user_id | UUID (FK) | User ID |
| achievement_id | UUID (FK) | Achievement ID |
| earned_at | Timestamp | Earned time |

#### xp_transactions (XP ledger) design intent: audit log. If users complain about incorrect XP, or admins need to adjust XP manually, records are here.
| Column | Type | Notes |
| --- | --- | --- |
| id | UUID (PK) | Primary key |
| user_id | UUID (FK) | User ID |
| amount | Integer | XP amount |
| source_type | Enum ('lesson_complete', 'daily_bonus', 'admin_adjustment') | XP source description. Prevent abuse (e.g., limit daily_bonus) |
| reference_id | UUID | Reference ID (lesson_id) |
| created_at | Timestamp | Creation time |

### 5. Social

#### follows (follow relationships, standard social network model. Allows users to follow good course authors or other top learners)
| Column | Type | Notes |
| --- | --- | --- |
| follower_id | UUID (FK) | Follower ID, references profiles |
| following_id | UUID (FK) | Followed user ID, references profiles |
| created_at | Timestamp | Creation time |
| **Primary Key** | **(follower_id, following_id)** | Composite PK |
CHECK (follower_id <> following_id) + PK(follower_id, following_id) to prevent self-follow

#### course_feedback (course feedback)
| Column | Type | Notes |
| --- | --- | --- |
| id | UUID (PK) | Primary key |
| user_id | UUID (FK) | User ID |
| course_id | UUID (FK) | Course ID |
| rating | Integer | Rating (1-5): star rating |
| comment | Text | Text review. Displayed on course intro page to help other users decide |
| created_at | Timestamp | Creation time |

### 6. System & Subscription

#### app_versions (version control)
| Column | Type | Notes |
| --- | --- | --- |
| version | Text | Version number (e.g., '1.0.2') |
| platform | Enum ('ios', 'android', 'web') | Platform |
| is_mandatory | Boolean | Force update toggle. If the API has breaking changes and old apps would crash, set mandatory=true. Old apps detect the flag and force users to update before they can use the app |
| changelog | Text | Release notes |

#### subscriptions (membership subscriptions)
| Column | Type | Notes |
| --- | --- | --- |
| id | UUID (PK) | Primary key |
| user_id | UUID (FK) | User ID |
| plan_id | Text | Plan ID (Stripe/AppStore) corresponds to product ID in payment platforms (Stripe, Apple IAP, Google Play Billing) |
| status | Enum ('active', 'canceled', 'expired') | active: paying and can access all premium courses; canceled: auto-renewal canceled but still has access until current period ends; expired: subscription expired, access revoked |
| start_date | Timestamp | Start time |
| end_date | Timestamp | End time |
